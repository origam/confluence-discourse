# Extending Work Queue Notifications With a New Contact Type

It comes handy when you want to send notifications to recipients that are to be computed dynamically based on the data. E.g. send a notification to all staff of order's business unit.

Can be also used to generate senders as well.

# Step-by-step guide

1.  Insert a new notification contact type into a database  
    In our example we are going to extract a customer email from a booking (rental transaction). So this type of contact can be used in many notifications which involves that booking - e.g. various state changes (new, reservation expired, has been closed, etc.)  
      
    ![9404527_690x138](upload://oUSmcFFS4oV1l7fpJiHDeOUjjD8.png)

    If you have a multi-lingual application, you can also add translations of the newly created contact type by inserting the records into `WorkQueueNotificationContactType_l10n` table.

2.  Extend `GetNotificationContacts` Workflow to handle out new contact type  
    The workflow is called from within WorkQueue notification subsystem.  
      
    ![9404531_663x343](upload://wDG1Athbfhz5YebkxGkXSmEPJ2J.png)  
      
    The picture shows the target state of workflow. So that's it. The next steps will describe how to achive this result.

3.  Create a new data constant with an **Id** of your new notification data type  
    **Data \> Constants \> YouPackageName \> New \> Data Constant**  
      
    ![9404533_690x232](upload://oLk4QNVx1GaDIFptxctOPTmsFVe.png)

4.  Create an XPath rule to identify your contact type  
    **Business Logic \> Rules \> YourPackageName \> New \> Start Rule**  
    This rule we are going to use in the step of workflow in order to identify and process only notifications with our notification contact type selected.  
      
    ![9404532_690x283](upload://3r1hXccOqPoJd4asVA7g5LWoLWZ.png)

5.  In `GetNotificationContact` workflow create a special step for processing our contact type.  
    Find `GetNotificationContact`, right click and select **New \> Block (Transaction)**  
      
    ![9404534_615x371](upload://cY5wMZsGd0yIIgFSpir0PUiR57G.png)

Create a workflow step/s with actual transformation (creation of a new AsapNotificationContact data structure)  
`GetNotificationContacts` has the following context stores:

![9404537_295x122](upload://nng0CWPoGrCo0iRKOCJTF2Drt5.png)

<table class="confluenceTable">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<tbody>
<tr class="header">
<th class="confluenceTh">Context Store</th>
<th class="confluenceTh">Type</th>
<th class="confluenceTh"></th>
</tr>

<tr class="odd">
<th class="confluenceTh">AsapNotificationContactData</th>
<td class="confluenceTd">Output</td>
<td class="confluenceTd"><p>A data structure with a list of found contacts. This context store is a return one and it has to be filled with contacts.</p>
![9404538_226x52](upload://xgHdoVGDFKPqYu8a583TfdPKOe2.png)
<p>![9404549_217x124](upload://6FicNnO5tzyHqTrmuzKSorSOOiy.png)</p></td>
</tr>
<tr class="even">
<th class="confluenceTh">asapNotificationChannelTypeId</th>
<td class="confluenceTd">Input</td>
<td class="confluenceTd">Email/Sms etc. (input)</td>
</tr>
<tr class="odd">
<th class="confluenceTh">context</th>
<td class="confluenceTd">Input</td>
<td class="confluenceTd">Data from a data structure defined in our WorkQueue class as a <strong>NotificationStructure.</strong> If not defined, the context will contain the "raw" data of the <strong>WorkQueueEntry</strong>.</td>
</tr>
<tr class="even">
<th class="confluenceTh">value</th>
<td class="confluenceTd">Input</td>
<td class="confluenceTd">A value passed from <strong>Notification Senders/Notification Recipients</strong> tab on the Work Queue screen. It is an additional control value that can be added by a user in the Work Queue notification configuration screen.</td>
</tr>
<tr class="odd">
<th class="confluenceTh">workQueueNotificationContactTypeId</th>
<td class="confluenceTd">Input</td>
<td class="confluenceTd">A type of notification contact. We already used this value for checking contact type in step 5.</td>
</tr>
</tbody>
</table>

The transformation has to have a target context store set to `AsapNotificationContactData`. We can create the transformation step by rigth-clicking on `AsapNotificationContactData` contextstore and choose **Action \> New Transform Task**.Then we have to set a **Data** parameter of that transformation to **Context** so we have set the input for the transformation.

![9404540_300x75](upload://o7RPA43jowPhHY0UF23NOZf3ITJ.png)

Now move the newly created transformation task under block task with the `NotificationContactType` condition.

Finally create a transformation that will produce contact data simillary as in the following example.

**Transformation example**

``` xml
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"
    xmlns:AS="http://schema.advantages.cz/AsapFunctions"
    xmlns:date="http://exslt.org/dates-and-times" exclude-result-prefixes="AS date">

    <xsl:template match="ROOT">
        <ROOT>
            <xsl:apply-templates select="RentalTransaction"/>
        </ROOT>
    </xsl:template>

    <xsl:template match="RentalTransaction">
        <AsapNotificationContact
            ContactIdentification="{@CustomerEmail}"
            Name="{@CustomerName}"
            refSalutationId="{@refCustomerSalutationId}"
        >
            <xsl:if test="string(@refCustomerLanguageId) != ''">
                <xsl:attribute name="LanguageTagIETF">
                    <xsl:value-of select="AS:LookupValue('7823d8af-4968-48c3-a772-287475d429e1',@refCustomerLanguageId)"/>
                </xsl:attribute>
            </xsl:if>
            <xsl:if test="string(@refCustomerSalutationId) != ''">
                <xsl:attribute name="Salutation">
                    <xsl:value-of select="AS:LookupValue('67d3131e-a81d-462d-830c-b67fdb2d6bb8', @refCustomerSalutationId)"/>
                </xsl:attribute>
            </xsl:if>
        </AsapNotificationContact>
    </xsl:template>
</xsl:stylesheet>
```

## AsapNotificationContact entity Description

|                       |           |                                                                                                                      |
|-----------------------|-----------|----------------------------------------------------------------------------------------------------------------------|
| Name                  | Mandatory | Description                                                                                                          |
| ContactIdentification | x         | Identification of a contact. Email in case of e-mail notification channel, phone number in case of SMS channel, etc. |
| Name                  |           | Name of contact (e.g. FirstName and Name, or just Name).                                                             |
| LanguageTagIETF       |           | Language tag, e.g. 'en-US' or 'de-DE'.                                                                               |
| refSalutationId       |           | Contact salutation identifier (Guid). Useful in a multilingual application.                                          |
| Salutation            |           | Contact salutation (string).                                                                                         |

# Example

**Example of notification template using generated contacts**

``` xml
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"
xmlns:AS="http://schema.advantages.cz/AsapFunctions"
xmlns:date="http://exslt.org/dates-and-times" exclude-result-prefixes="AS date">
<xsl:param name="RecipientRow" />

<xsl:template match="ROOT">

    <ROOT>
          <AsapNotification>
                 <xsl:attribute name="Subject">
                      <xsl:value-of select="concat('Rental Transaction ', /ROOT/RentalTransaction/@Number,' Booked')"/>
                 </xsl:attribute>
                 <Body>&lt;html&gt;
<xsl:variable name="salutation">
  <xsl:choose>
    <xsl:when test="string($RecipientRow/row/@refSalutationId) = ''">
      <xsl:value-of select="'Mr/Ms'" />
    </xsl:when>
    <xsl:otherwise>
       <xsl:value-of select="AS:LookupValue('67d3131e-a81d-462d-830c-b67fdb2d6bb8',$RecipientRow/row/@refSalutationId)"/>
    </xsl:otherwise>
  </xsl:choose>
...
```
