from pydiscourse import DiscourseClient
import json
import pprint
import os
import sys
import re
import shutil

SOURCE_ALL_DIR = "source_all/architect"
SOURCE_DIR = "source"
OUTPUT_FILE_POSTFIX = ""

# ----------------------------------------------------------------
def prepareHtml(_fileFullName):
	# read from file
	_readingFile = open(_fileFullName, "r", encoding="utf-8")
	_newFileContent = _readingFile.read()
	_readingFile.close()
	
	# remove attachments section
	_newFileContent = re.sub('<div class="pageSection group">(\r|\n)*(\s*)<div class="pageSectionHeader">(\r|\n)*(\s*)<h2 id="attachments" class="pageSectionTitle">Attachments:</h2>(.|\r|\n)*<div id="footer" role="contentinfo">', '</div></div><div id="footer" role="contentinfo">', _newFileContent)

	# images and files
	_newFileContent = re.sub('<img(.*?) src="attachments/(.*?)/(.*?)\.(.*?)"(.*?)>', '#TODO_FILE:\\3#', _newFileContent)
	_newFileContent = re.sub('<a href="attachments/(.*?)/(.*?)\.(.*?)"(.*?)>', '#TODO_FILE:\\2#', _newFileContent)
	_newFileContent = re.sub('<img src="images/(.*?)/>', '', _newFileContent)
	_newFileContent = re.sub('<img class="waiting-image" alt="Please wait" src="images/icons/wait.gif">', '', _newFileContent)

	# special characters
	_newFileContent = _newFileContent.replace("í", "í")
	_newFileContent = _newFileContent.replace(" ", " ")
	_newFileContent = _newFileContent.replace("–", "-")
	_newFileContent = _newFileContent.replace("rel=\"nofollow\"", "")
	_newFileContent = _newFileContent.replace("class=\"external-link\"", "")
	_newFileContent = _newFileContent.replace("<hr/>", "---")
	_newFileContent = _newFileContent.replace("Context+Store+Reference", "Context-Store-Reference")
	_newFileContent = _newFileContent.replace("Data+Constant+Reference", "Data-Constant-Reference")
	_newFileContent = _newFileContent.replace("Data+Structure+Reference", "Data-Structure-Reference")
	_newFileContent = _newFileContent.replace("\"https://www.origam.com/doc/display/architect/Context-Store-Reference\"", "\"Context-Store-Reference_8290726.html\"")
	_newFileContent = _newFileContent.replace("\"https://www.origam.com/doc/display/architect/Data-Constant-Reference\"", "\"Data-Constant-Reference_8290728.html\"")
	_newFileContent = _newFileContent.replace("\"https://www.origam.com/doc/display/architect/Data-Structure-Reference\"", "\"Data-Structure-Reference_8290732.html\"")
	
	# write to file
	_writingFile = open(_fileFullName + OUTPUT_FILE_POSTFIX, "w", encoding="utf-8")
	_writingFile.write(_newFileContent)
	_writingFile.close()

# ----------------------------------------------------------------
def prepareAllHtmls(_rootDir,_print = False):
	_allFiles = os.walk(_rootDir)
	_allFilesCount = 0
	_fileCount = 0
	
	for _subdir, _dirs, _files in _allFiles:
		_allFilesCount += len(_files)
		_fileNumber = 0
		for _file in _files:
			_fileNumber += 1
			if _file.endswith(".html"):
				_fileCount = _fileCount + 1
				_fileFullName = os.path.join(_subdir, _file)
				
				print ("[" + str(_fileNumber) + "/" + str(_allFilesCount) + "] " + _fileFullName)
				prepareHtml(_fileFullName)

# ----------------------------------------------------------------
def copyFromSourceAll():
	print ("Copying html files from " + SOURCE_ALL_DIR + " to " + SOURCE_DIR)
	_allFiles = os.walk(SOURCE_ALL_DIR)
	_allFilesCount = 0
	_fileCount = 0
	
	for _subdir, _dirs, _files in _allFiles:
		_allFilesCount += len(_files)
		_fileNumber = 0
		for _file in _files:
			_fileNumber += 1
			if _file.endswith(".html"):
				_fileCount = _fileCount + 1
				# print ("Copying from " + SOURCE_ALL_DIR + " to " + SOURCE_DIR + ": " + _file)
				shutil.copy(SOURCE_ALL_DIR + "/" + _file, SOURCE_DIR + "/" + _file)

# ----------------------------------------------------------------
# ----------------------------------------------------------------
# ----------------------------------------------------------------

copyFromSourceAll()
print ("---------------------------------------------")
prepareAllHtmls(SOURCE_DIR)